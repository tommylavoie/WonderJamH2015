//------------------------------------------------------------------------------
// <auto-generated>
//     Ce code a été généré par un outil.
//     Version du runtime :4.0.30319.18052
//
//     Les modifications apportées à ce fichier peuvent provoquer un comportement incorrect et seront perdues si
//     le code est régénéré.
// </auto-generated>
//------------------------------------------------------------------------------
using System.Collections;
using System;
using UnityEngine;
public class WaveManager : MonoBehaviour
{
	public GameObject enemyPrefab;
	public Map map;
	public int timeBetweenWaves = 5;
	public int timeBetweenEnnemies = 3;
	int level;
	int numberOfEnemies;
	bool waveStarted;
	bool waveInvoked;
	bool ennemiesInvoked;
	float timer = 0;
	bool timerStarted = false;
	float waveTextX = 1000;
	int ennemiesOnMap = 0;
	
	void Start()
	{
		map = Map.Instance;
		level = 0;
		numberOfEnemies = -1;
		waveStarted = false;
		ennemiesInvoked = false;
		waveInvoked = false;
		waveTextX = Screen.width;
	}

	void FixedUpdate()
	{
		if(timerStarted)
			timer += Time.deltaTime;
		if(Map.Instance.isStarted() && !map.isGameOver())
		{
			if (numberOfEnemies > 0 && !ennemiesInvoked) 
			{
				Invoke ("addEnnemies", timeBetweenEnnemies);
				ennemiesInvoked = true;
			} 
			if (!waveStarted && !waveInvoked) 
			{
				Invoke ("startNextWave", timeBetweenWaves);
				timerStarted = true;
				timer = 0;
				waveInvoked = true;
			}

			GameObject[] ennemies = GameObject.FindGameObjectsWithTag("Enemy");
			ennemiesOnMap = ennemies.Length;
			if(ennemiesOnMap <= 0 && numberOfEnemies <= 0)
			{
				endWave();
			}
		}
	}

	void LateUpdate()
	{
		if(waveTextX < Screen.width)
			waveTextX += 7;
	}

	public void startNextWave()
	{
		SoundEffectScript.Instance.MakeNext_waveSound();
		timerStarted = false;
		timer = timeBetweenWaves;
		level++;	
		numberOfEnemies = level*2;
		waveStarted = true;
		waveInvoked = false;
		Map.Instance.setWaveStarted(true);
		waveTextX = -30f;
	}

	public Path getEnemyPath(string startNode)
	{
		Path path = map.createPath(map.getNodeByName(startNode), map.getNodeByName("F1"));
		return path;
	}

	public void addEnnemies()
	{
		string[] startNode = new string[] {"A1", "A2", "A3"};
		for(int i=0;i<3;i++)
		{
			if(numberOfEnemies > 0)
			{
				Path enemyPath = getEnemyPath(startNode[i]);
				enemyPrefab.transform.position = map.getNodeByName(startNode[i]).gameObject.transform.position;
				GameObject enemyObject = (GameObject)Instantiate(enemyPrefab);
				EnemyScript enemy = enemyObject.GetComponent<EnemyScript>();
				enemy.setPath(enemyPath);
				numberOfEnemies--;
			}
		}
		ennemiesInvoked = false;
	}

	public void endWave()
	{
		waveStarted = false;
		GameObject[] projectiles = GameObject.FindGameObjectsWithTag("TowerProjectile");
		foreach(GameObject projectile in projectiles)
		{
			Destroy(projectile);
		}

		GameObject[] pprojectiles = GameObject.FindGameObjectsWithTag("PlayerProjectile");
		foreach(GameObject pprojectile in pprojectiles)
		{
			Destroy(pprojectile);
		}

		Map.Instance.setWaveStarted(false);
	}

	public void OnGUI()
	{
		GUIStyle style = new GUIStyle();
		style.fontSize = 20;
		style.normal.textColor = Color.white;
		GUI.Label(new Rect(Screen.width-130,0, 130, 20), "Ennemis restants: " + Math.Max(ennemiesOnMap, numberOfEnemies));
		if(timerStarted)
			GUI.Label(new Rect(Screen.width-130,10, 130, 20), "Prochaine vague: " + Mathf.Round((timeBetweenWaves - timer)));
		GUI.Label(new Rect(waveTextX,Screen.height/6, 130, 20), "Vague " + this.level, style);
	}
}

